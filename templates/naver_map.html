<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Naver Map WebView (Vanilla JS)</title>
  <style>
    /* 지도 영역 스타일 */
    #map {
      width: 100%;
      height: 100vh;
    }
  </style>
</head>
<body>
  <!-- 지도 컨테이너: 만약 HTML에 직접 작성하지 않으면 아래 코드에서 동적 생성 -->
  <div id="map"></div>

  <!-- get_polygon_api 함수를 포함한 필요한 스크립트를 불러오거나 정의 -->
  <script>
    // 예시: get_polygon_api 함수 (실제 API 호출 코드로 교체하세요)
    async function get_polygon_api(x, y) {
      // 여기에서 x, y 좌표를 이용해 폴리곤 데이터를 가져오는 API를 호출합니다.
      // 아래는 예시 데이터입니다.
      return [
        new window.naver.maps.LatLng(25.141, 126.925),
        new window.naver.maps.LatLng(25.142, 126.926),
        new window.naver.maps.LatLng(25.143, 126.924)
      ];
    }
  </script>

  <!-- 메인 스크립트 -->
  <script>
    (function () {
      // 전역 변수 (현재 지도에 표시된 폴리곤 및 중심 좌표)
      const currentPolygon = null;
      const currentCenter = null;

      // DOMContentLoaded 이벤트에서 실행
      document.addEventListener("DOMContentLoaded", function () {
        // 지도 컨테이너가 없다면 동적으로 생성
        if (!document.getElementById("map")) {
          const mapDiv = document.createElement("div");
          mapDiv.id = "map";
          mapDiv.style.width = "100%";
          mapDiv.style.height = "100vh";
          document.body.appendChild(mapDiv);
        }

        // 네이버 지도 API 스크립트 로드
        if (typeof window.naver === "undefined") {
          const script = document.createElement("script");
          // 반드시 YOUR_CLIENT_ID 부분을 실제 클라이언트 아이디로 교체하세요.
          script.src = "https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=hmpfs1a6fl";
          script.async = true;
          script.onload = initMap; // 스크립트 로드 완료 후 지도 초기화
          document.head.appendChild(script);
        } else {
          initMap(); // API가 이미 로드된 경우 바로 초기화
        }
      });

      // 지도 초기화 함수
      function initMap() {
        const naver = window.naver;
        if (!naver || !naver.maps) {
          console.error("Naver Maps API가 제대로 로드되지 않았습니다.");
          return;
        }

        // 지도 객체 생성
        const map = new naver.maps.Map("map", {
          center: new naver.maps.LatLng(35.1409402, 126.925774), // 초기 중심 좌표
          zoom: 15, // 초기 확대 수준
          draggable: false, // 드래그 이동 비허용
          pinchZoom: false, // 핀치 줌 비활성화 (모바일)
          scrollWheel: false, // 스크롤 휠 확대/축소 비활성화
          keyboardShortcuts: false, // 키보드 확대/축소 비활성화
          disableDoubleTapZoom: true, // 더블 탭 확대 비활성화
          disableDoubleClickZoom: true, // 더블 클릭 확대 비활성화
          mapTypeControl: false, // 지도 타입 컨트롤 비활성화
        });

        // 줌 레벨 고정: 사용자가 줌을 변경하려 할 경우 다시 15로 설정
        naver.maps.Event.addListener(map, "zoom_changed", function () {
          map.setZoom(15);
        });

        // 플러터 혹은 외부에서 전달하는 메시지 처리 시작
        handleFlutterMessage(map);
      }

      // 플러터(또는 외부)로부터 전달된 메시지 처리 함수
      function handleFlutterMessage(map) {
        window.addEventListener("message", async function (event) {
          try {
            const { action, payload } = JSON.parse(event.data);
            if (action === "searchAddress") {
              // 전달받은 주소 정보를 이용해 지도 업데이트
              await searchAddressToCoordinate(payload.address, map);
            }
          } catch (error) {
            console.error("플러터로부터 전달된 메시지 파싱 실패:", error);
          }
        });
      }

      // 주소를 좌표로 변환하고 폴리곤을 표시하는 함수
      function searchAddressToCoordinate(address, map) {
        return new Promise((resolve, reject) => {
          const naver = window.naver;
          let isErrorSent = false; // 중복 에러 전송 방지 플래그

          naver.maps.Service.geocode({ query: address }, async function (status, response) {
            if (status === naver.maps.Service.Status.ERROR) {
              if (!isErrorSent) {
                sendToFlutter("error", "주소 검색에 실패했습니다.");
                isErrorSent = true;
              }
              reject("주소 검색에 실패했습니다.");
              return;
            }

            if (response.v2.meta.totalCount === 0) {
              if (!isErrorSent) {
                sendToFlutter("error", "해당 주소를 찾을 수 없습니다.");
                isErrorSent = true;
              }
              reject("해당 주소를 찾을 수 없습니다.");
              return;
            }

            const item = response.v2.addresses[0]; // 첫 번째 검색 결과 사용
            const point = new naver.maps.Point(item.x, item.y); // 좌표 객체 생성

            // 지도 중심 이동
            map.setCenter(point);
            currentCenter = point;

            // 폴리곤 데이터 요청 및 지도에 표시
            try {
              await showPolygonData(point, map);
              resolve();
            } catch (err) {
              reject(err);
            }
          });
        });
      }

      // URL Scheme을 활용해 데이터를 전달하는 함수
      function sendToFlutter(eventType, data) {
        let url = `customscheme://event?type=${eventType}`;
        if (eventType === "searchAddress") {
          url += `&address=${encodeURIComponent(data)}`;
        } else if (eventType === "error") {
          url += `&message=${encodeURIComponent(data)}`;
        }
        window.location.href = url;
      }

      // 폴리곤 데이터 요청 및 지도에 표시 함수
      async function showPolygonData(point, map) {
        try {
          const polygonData = await get_polygon_api(point.x, point.y); // API 호출 (좌표 기준)
          if (!polygonData) {
            console.warn("폴리곤 데이터를 받지 못했습니다.");
            return;
          }

          // 기존 폴리곤 제거
          if (currentPolygon) {
            currentPolygon.setMap(null);
          }

          // 새 폴리곤 생성 및 지도에 추가
          currentPolygon = new window.naver.maps.Polygon({
            map: map,
            paths: polygonData, // 폴리곤 경로 데이터
            fillColor: "#a1bdff", // 채우기 색상
            fillOpacity: 0.3, // 채우기 투명도
            strokeColor: "#2768ff", // 테두리 색상
            strokeOpacity: 0.6, // 테두리 투명도
            strokeWeight: 3, // 테두리 두께
          });
        } catch (error) {
          console.error("폴리곤 데이터 요청 실패:", error);
        }
      }
    })();
  </script>
</body>
</html>
