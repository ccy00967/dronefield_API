<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>NICE 본인인증</title>
</head>
<body>

<h1>NICE 본인인증 테스트</h1>

<!-- 본인인증 버튼 -->
<button onclick="openNicePopup()">본인인증</button>

<script>
    function openNicePopup() {
        fetch('http://127.0.0.1:8000/user/nice-token/', {
            method: 'POST',
            mode: 'cors',  // CORS 요청 설정
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                "returnURL": "http://127.0.0.1:8000/user/nice-callback/"
            })
        })
        .then(response => {
            // 응답이 JSON 형태가 아닌 경우 처리
            if (!response.ok) {
                throw new Error("서버에서 응답을 받지 못했습니다.");
            }
            return response.json();
        })
        .then(data => {
            // enc_data와 token_version_id 검증
            if (!data.enc_data || !data.token_version_id) {
                console.error("enc_data 또는 token_version_id가 누락되었습니다.");
                alert("인증 데이터 생성에 실패했습니다. 다시 시도해 주세요.");
                return;
            }

            let form = document.createElement('form');
            form.method = 'POST';
            form.action = 'https://nice.checkplus.co.kr/CheckPlusSafeModel/checkplus.cb';
    
            let encDataField = document.createElement('input');
            encDataField.type = 'hidden';
            encDataField.name = 'm';
            encDataField.value = data.enc_data;
    
            let tokenField = document.createElement('input');
            tokenField.type = 'hidden';
            tokenField.name = 'token_version_id';
            tokenField.value = data.token_version_id;
    
            form.appendChild(encDataField);
            form.appendChild(tokenField);
            document.body.appendChild(form);
            form.submit();
        })
        .catch(err => {
            console.error("NICE 인증 요청 실패: ", err);
            alert("NICE 인증 요청에 실패했습니다. 서버 상태를 확인해 주세요.");
        });
    }
</script>

</body>
</html>
